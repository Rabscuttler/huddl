<script>
  $(function () {
    
    $(".roles").sortable({
      update: function (event, ui) {
        $.post('/roles/order', {rota_id: $(event.target).attr('data-rota-id'), role_ids: $(event.target).sortable("toArray")}, function () {
          $(event.target).next().show()
        })
      }
    });

    $(".rslots").sortable({
      update: function (event, ui) {
        $.post('/rslots/order', {rota_id: $(event.target).attr('data-rota-id'), rslot_ids: $(event.target).sortable("toArray")}, function () {
          $(event.target).next().show()
        })
      }
    });

  })
</script>

<style>
  .activity a, .activity span { font-size: 12px; color: white }
  .activity, .activity-accept { height: 120px }
  td .activity, td .activity-accept { width: 240px }
  .activity h3 { font-size: 18px; line-height: 20px }
  .roles li, .rslots li { cursor: move }
</style>

<%= partial :group_header %>

<% if @membership.admin? %>
  <% form_tag "/rotas/create?group_id=#{@group.id}" do %>
    <%= text_field_tag :name, :class => 'form-control', :style => 'width: 10em', :placeholder => 'New rota' %>
  <% end %>
<% end %>

<% @group.rotas.each { |rota| %>
  <h2>
    <% if @membership.admin? %>
      <a data-confirm="Delete this rota?" href="/rotas/<%=rota.id%>/destroy">
        <%=rota.name%>
      </a>
    <% else %>
      <%=rota.name%>
    <% end %>     
  </h2>

  <table class="table table-striped">
    <tr>
      <td></td>
      <% rota.rslots.order('o asc').each { |rslot| %>
        <td>
          <strong>
            <% if @membership.admin? %>
              <a data-confirm="Delete this slot?" href="/rslots/<%=rslot.id%>/destroy">
                <%=rslot.name%>
              </a>
            <% else %>
              <%=rslot.name%>
            <% end %>   
          </strong>
        </td>
      <% } %>
      <% if @membership.admin? %>
        <td>        
          <% form_tag "/rslots/create?rota_id=#{rota.id}", :class => 'form-inline', :style => 'display: inline' do %>
            <%= text_field_tag :name, :class => 'form-control', :style => 'width: 10em', :placeholder => 'New slot' %>
          <% end %>           
        </td>
      <% end %>
    </tr>
    <% rota.roles.order('o asc').each { |role| %>
      <tr>
        <td>
          <strong>
            <% if @membership.admin? %>
              <a data-confirm="Delete this role?" href="/roles/<%=role.id%>/destroy">
                <%=role.name%>
              </a>
            <% else %>
              <%=role.name%>
            <% end %> 
          </strong>
        </td>
        <% rota.rslots.order('o asc').each { |rslot| %>
          <td>
            <div data-pagelet-url="/rota/rslot/role/<%=rota.id%>/<%=rslot.id%>/<%=role.id%>">
              <%= partial :'rotas/rota_rslot_role', :locals => {:rota => rota, :rslot => rslot, :role => role} %>
            </div>
          </td>          
        <% } %>
        <% if @membership.admin? %>
          <td></td>
        <% end %>
      </tr>
    <% } %>
    <% if @membership.admin? %>
      <tr>      
        <td>        
          <% form_tag "/roles/create?rota_id=#{rota.id}", :class => 'form-inline', :style => 'display: inline' do %>
            <%= text_field_tag :name, :class => 'form-control', :style => 'width: 10em', :placeholder => 'New role' %>
          <% end %>          
        </td>      
      </tr>
    <% end %>
  </table>

  <% if @membership.admin? %>

    <a class="btn btn-primary" href="javascript:;" onclick="$(this).hide().next().show()"><i class="fa fa-exchange"></i> Reorder</a>
    <div style="display: none" class="activity-form">

      <h3>Reorder roles</h3>
      <ul class="roles" data-rota-id="<%=rota.id%>">
        <% rota.roles.order('o asc').each { |role| %>
          <li id="<%=role.id%>"><%= role.name %></li>
        <% } %>
      </ul>
      <p style="display: none">
        <em>Refresh the page to see your changes</em>
      </p>              

      <h3>Reorder slots</h3>
      <ul class="rslots" data-rota-id="<%=rota.id%>">
        <% rota.rslots.order('o asc').each { |rslot| %>
          <li id="<%=rslot.id%>"><%= rslot.name %></li>
        <% } %>
      </ul>  
      <p style="display: none">
        <em>Refresh the page to see your changes</em>
      </p>              

    </div>        

  <% end %>

<% } %>